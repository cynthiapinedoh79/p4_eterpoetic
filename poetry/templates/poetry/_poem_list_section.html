{% load static %}
{% static 'images/placeholder.png' as PLACEHOLDER_IMG %}
{% static 'images/placeholder_coll.png' as PLACEHOLDER_COLL_IMG %}

<div class="container mt-4 poetry-list">

  <div class="d-flex align-items-center justify-content-between mb-3">
    {% if not hide_page_title %}<h1 class="mb-0">{% if page_mode == 'collections' %}Collections{% else %}Poems{% endif %}</h1>{% endif %}
    {% if total %}<span class="text-muted">{{ total }} result{{ total|pluralize }}</span>{% endif %}
  </div>

  <form method="get" class="search-form d-flex flex-column flex-md-row justify-content-center align-items-center gap-2 mb-4">
    <input type="text" class="form-control search-input" name="q" value="{{ q }}" placeholder="Search Poems (ES/EN)">
    
    <select class="form-select search-input" name="collection" aria-label="Filter by collection" style="min-width: 200px;">
      
      <option value="" {% if not current_collection_slug %}selected{% endif %}>
        All Collections
      </option>
      <option value="all-poems" {% if current_collection_slug == 'all-poems' %}selected{% endif %}>
        All Poems
      </option>
      
      {% for collection in all_collections %}
        <option value="{{ collection.slug }}" {% if collection.slug == current_collection_slug %}selected{% endif %}>
          {{ collection.name_en|default:collection.name_es }}
        </option>
      {% endfor %}
    </select>

    {# --- NEW: Author Filter Dropdown --- #}
    <select class="form-select search-input" name="author" aria-label="Filter by author" style="min-width: 200px;">
      <option value="" {% if not current_author_slug %}selected{% endif %}>
        All Authors
      </option>
      
      {% for author in all_authors %}
        <option value="{{ author.slug }}" {% if author.slug == current_author_slug %}selected{% endif %}>
          {{ author.name }}
        </option>
      {% endfor %}
    </select>
    {# --- End of New Dropdown --- #}
    
    <div class="d-flex gap-2 mt-2 mt-md-0">
      <button class="btn btn-secondary px-4">Search</button>
      {% if q or current_collection_slug or current_author_slug %}{# <-- MODIFIED: Added author check #}
        <a class="btn btn-outline-secondary" href="{% url 'poetry:poetry_home' %}">Clear</a>
      {% endif %}
    </div>
  </form>
  
  {% comment %}
  =======================================================
  =                                                     =
  =   SECTION 1: COLLECTION "ALBUM" VIEW                =
  =   This is shown if page_mode == 'collections'       =
  =                                                     =
  =======================================================
  {% endcomment %}
  {% if page_mode == 'collections' %}
    {% if page_obj.object_list %}
      <div class="row g-4">
        {% for collection in page_obj.object_list %}
          <div class="col-12 col-sm-6 col-lg-3 col-xxl-2">
            <a href="?collection={{ collection.slug }}" class="card text-decoration-none collection-album-card h-100 shadow-sm">
              {% if collection.collection_image and "placeholder" not in collection.collection_image.url %}
                <img src="{{ collection.collection_image.url }}" class="card-img-top" alt="{{ collection.name_en }}">
              {% else %}
                <img src="{{ PLACEHOLDER_COLL_IMG }}" class="card-img-top" alt="Placeholder image">
              {% endif %}
              <div class="card-body">
                <h5 class="card-title mb-1">{{ collection.name_en|default:collection.name_es }}</h5>
                <p class="card-text text-muted small">
                  {# --- THIS IS THE CORRECTED LINE --- #}
                  {{ collection.description_en|default:collection.description_es|striptags|truncatechars:100 }}
                </p>
              </div>
            </a>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-light border text-secondary">No collections found.</div>
    {% endif %}
  
  {% comment %}
  =======================================================
  =                                                     =
  =   SECTION 2: POEM LIST VIEW                         =
  =   This is shown if page_mode == 'poems'             =
  =                                                     =
  =======================================================
  {% endcomment %}
  {% else %}
    {% if page_obj.object_list %}
      {% if current_collection %}
        <div class="card mb-4 p-4 shadow-sm collection-detail-card">
          <div class="row g-3 align-items-center">
            
            <div class="col-12 col-md-4">
              {% if current_collection.collection_image and "placeholder" not in current_collection.collection_image.url %}
                <img src="{{ current_collection.collection_image.url }}" 
                     alt="{{ current_collection.name_en }} collection image" 
                     class="img-fluid rounded-3 shadow-sm">
              {% else %}
                <img src="{{ PLACEHOLDER_COLL_IMG }}" 
                     alt="Placeholder image" 
                     class="img-fluid rounded-3 shadow-sm">
              {% endif %}
            </div>

            <div class="col-12 col-md-8">
              <h3 class="mb-2">{{ current_collection.name_en|default:current_collection.name_es }} Collection</h3>
              <p class="text-muted">{{ current_collection.description_en|default:current_collection.description_es }}</p>
            </div>

          </div>
        </div>
      {% endif %}

      <div class="row g-4">
        {% for poem in page_obj.object_list %}
          <div class="col-12 col-sm-6 col-lg-3 col-xxl-2">
            <div class="card h-100 {% if poem.is_featured %}is-featured{% else %}shadow-sm{% endif %}">
              <div class="image-wrap">
                {% if poem.is_featured %}<span class="feature-flag" aria-label="Featured">Featured</span>{% endif %}
                {% if poem.featured_image and "placeholder" not in poem.featured_image.url %}
                  <img src="{{ poem.featured_image.url }}" class="card-img-top" alt="{{ poem.title }}">
                {% else %}
                  <img src="{{ PLACEHOLDER_IMG }}" class="card-img-top" alt="Placeholder image">
                {% endif %}
              </div>
              <div class="card-body">
                <h5 class="card-title mb-1">
                  <a class="post-link" href="{{ poem.get_absolute_url }}">{{ poem.title_es|default:poem.title_en }}</a>
                </h5>
                {% if poem.collection %}<p class="text-muted small mb-1">ü™∂ {{ poem.collection.name_es|default:poem.collection.name_en }}</p>{% endif %}
                {% if poem.author %}<p class="text-muted small mb-2">‚úçÔ∏è {{ poem.author.name }}</p>{% endif %}
                <p class="card-text text-muted">{{ poem.body_es|default:poem.body_en|striptags|truncatechars:140 }}</p>
              </div>
              <div class="card-footer bg-white d-flex justify-content-between small text-muted">
                <span>{{ poem.created|date:"M d, Y" }}</span>
                {% if poem.body_en and poem.body_es %}<span>ES ‚Ä¢ EN</span>
                {% elif poem.body_en and not poem.body_es %}<span>EN</span>
                {% else %}<span>ES</span>{% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

    {% else %}
      <div class="alert alert-light border text-secondary">No poems found.</div>
    {% endif %}
  {% endif %}

  {% if page_obj.paginator.num_pages > 1 %}
  <nav aria-label="Poem pages" class="mt-5">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item">
          {# --- MODIFIED: Added author --- #}
          <a class="page-link" href="?q={{ q }}&collection={{ current_collection_slug }}&author={{ current_author_slug }}&page={{ page_obj.previous_page_number }}">Previous</a>
        </li>
      {% else %}<li class="page-item disabled"><span class="page-link">Previous</span></li>{% endif %}
      
      <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>
      
      {% if page_obj.has_next %}
        <li class="page-item">
          {# --- MODIFIED: Added author --- #}
          <a class="page-link" href="?q={{ q }}&collection={{ current_collection_slug }}&author={{ current_author_slug }}&page={{ page_obj.next_page_number }}">Next</a>
        </li>
      {% else %}<li class="page-item disabled"><span class="page-link">Next</span></li>{% endif %}
    </ul>
  </nav>
  {% endif %}

</div>